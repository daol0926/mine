"use strict";var $prite=$prite||{};function makeEaseOut(e){return function(t){return 1-e(1-t)}}function linear(t){return t}$prite=function(){var h={currentAni:null,currentSpriteId:null,currentSeq:0,spriteList:{},originalSpriteList:null,sound:{},index:0,row:0,isChrome:-1!=navigator.userAgent.toLowerCase().indexOf("chrome"),add:function(p){var L=p.spriteId;this.initSpriteListObj(L),0<p.spriteList.length?p.spriteList.forEach(function(r,t){var e=$ts.ce({tag:"div",class:"characterImg",parent:p.target});e.classList.add(r.name),r.top&&(e.style.top=r.top+"px"),r.left&&(e.style.left=r.left+"px"),r.circle&&(e.classList.add("circle"),e.classList.add(r.circle));var n=$ts.ce({tag:"div",class:"charSpriteImg",parent:e});n.style.backgroundImage="url("+r.thumbNail+")",n.style.width=r.width+"px",n.style.height=r.height+"px";var a=$ts.ce({tag:"div",class:"charSpriteAni",parent:e});if(a.style.backgroundImage="url("+r.spriteSheet+")",a.style.width=r.width+"px",a.style.height=r.height+"px",a.setAttribute("data-idx",t),h.isChrome&&(a.style.opacity=0),h.spriteList[L].characterList.push(e),h.spriteList[L].sheetList.push(a),h.spriteList[L].thumbNailList.push(n),r.textBubble){var i=$ts.ce({tag:"div",class:r.textBubble.class,parent:p.target});i.style.width=r.textBubble.width+"px",i.style.top=r.textBubble.top+"px",i.style.left=r.textBubble.left+"px",i.setAttribute("data-sprite-balloon",""),i.style.textAlign=r.textBubble.textAlign,i.style.wordBreak=r.textBubble.wordBreak;e=$ts.ce({tag:"span",parent:i});if(e.innerHTML=r.textBubble.text,r.textBubble.images){var s=document.createElement("div");s.className=r.textBubble.imagesParentClass||"textAlignC";for(var l=0;l<r.textBubble.images.length;l++){var c=$ts.ce({tag:"img",parent:s});c.src=r.textBubble.images[l],c.height=r.textBubble.imagesHeight?r.textBubble.imagesHeight[l]:300}i.insertBefore(s,e)}}h.spriteList[L].textBubbleList.push(i);var o=r.sheetWidth/r.width,d=r.sheetHeight/r.height,u=o*d-(r.endSheet+1);a.addEventListener("click",function(t){if(t.preventDefault(),h.currentSpriteId=L,h.originalSpriteList=p.spriteList,this.classList.contains("waiting"))this.classList.remove("waiting"),$prite.resetSprite(L),r.callbacks&&r.callbacks.end&&r.callbacks.end();else{var e=function e(){clearInterval(h.currentAni),h.currentAni=null,h.index=0,h.row=0,h.spriteAnimate({delay:r.delay,duration:u*r.delay,delta:makeEaseOut(linear),step:function(t){h.index++,h.index>=o&&(h.index=0,h.row++),h.row===d-1&&h.index===o-r.endSheet||h.changeSpritePos({x:-(h.index*r.width),y:-(h.row*r.height),target:a}),1===t&&(i.element.paused?(n.style.opacity=1,a.style.opacity=0,r.circlePlayMode&&(a.style.pointerEvents="auto")):e())}})},t=this.getAttribute("data-idx"),i=h.sound["sound_"+r.name];h.allStopSound(),i.playSound(),h.hideOtherSprite();for(var s=0;s<h.spriteList[L].sheetList.length;s++)h.spriteList[L].thumbNailList[s].style.opacity=1,h.spriteList[L].sheetList[s].classList.remove("waiting"),h.spriteList[L].textBubbleList[s]&&h.spriteList[L].textBubbleList[s].classList.remove("on");if(n.style.opacity=0,this.style.opacity=1,this.classList.add("waiting"),h.changeSpritePos({x:"0",y:"0",target:this}),r.circlePlayMode){h.initCirclePlayMode(L,p.spriteList);for(s=0;s<h.spriteList[L].sheetList.length;s++)h.spriteList[L].sheetList[s].style.pointerEvents="auto"}t=h.spriteList[L].textBubbleList[t];t&&(t.style.display="",t.classList.add("on")),e(),r.callbacks&&r.callbacks.start&&r.callbacks.start()}},!1),h.addSound({id:"sound_"+r.name,src:r.sound,autoPlay:!1,volume:.7,callBack:function(){n.style.opacity=1,a.style.opacity=0;var t,e=h.currentSpriteId;r.circlePlayMode&&r.circlePlayMode.rewind&&h.rewindMode(h.currentSpriteId,p.spriteList),h.spriteList[e].sequenceList&&h.spriteList[e].sequenceList[h.currentSeq].callBack&&h.spriteList[e].sequenceList[h.currentSeq].callBack(),h.currentSeq++,h.spriteList[e].sequenceList&&h.spriteList[e].sequenceList[h.currentSeq]?(t=h.spriteList[e].sequenceList[h.currentSeq].seq,h.spriteList[e].sheetList[t-1].click()):h.currentSeq=0}})}):alert("$pAni error: spriteList parameter is not find!")},initSpriteListObj:function(t){this.spriteList[t]={sheetList:[],characterList:[],thumbNailList:[],textBubbleList:[],sequenceList:null}},changeSpritePos:function(t){t.target.style.backgroundPositionX=t.x+"px",t.target.style.backgroundPositionY=t.y+"px",t.target.style.transform="rotate(0.1deg)"},spriteAnimate:function(i){var s=new Date,r=setInterval(function(){var t=(new Date-s)/i.duration,e=i.delta(t=1<t?1:t);i.step(e),1===t&&clearInterval(r)},i.delay);h.currentAni=r},Sound:function(t){var e=this;e.element=t.element,t.volume&&(e.element.volume=t.volume),t.loop&&(e.element.loop=t.loop),t.callBack&&(e.callBack=t.callBack),e.endSound=function(){e.element.removeEventListener("ended",e.endSound),t.callBack&&t.callBack()},e.loadAndPlay=function(){e.element.removeEventListener("loadeddata",e.loadAndPlay),e.element.removeEventListener("ended",e.endSound),e.element.addEventListener("ended",e.endSound),t.autoPlay&&e.element.play()},e.setSrc=function(t){e.element.src=t,e.element.addEventListener("loadeddata",e.loadAndPlay),e.element.load()},e.seek=function(){return e.element.currentTime},e.playSound=function(){e.element.removeEventListener("loadeddata",e.loadAndPlay),e.element.removeEventListener("ended",e.endSound),e.element.addEventListener("ended",e.endSound),e.element.play()},e.setSrc(t.src)},addSound:function(t){var e=$ts.ce({tag:"audio",parent:document.body});e.setAttribute("id",t.id),e.style.display="none",this.sound[t.id]=new h.Sound({id:t.id,element:e,src:t.src,autoPlay:t.autoPlay,volume:t.volume,loop:t.loop,callBack:t.callBack})},allStopSound:function(){for(var t in this.sound)this.sound[t].element.pause(),0<this.sound[t].element.currentTime&&(this.sound[t].element.currentTime=0)},initCirclePlayMode:function(t,i){h.spriteList[t].characterList.forEach(function(t,e){t.classList.add("circle"),t.classList.add(i[e].circlePlayMode.class),t.style.top=i[e].circlePlayMode.top+"px",t.style.left=i[e].circlePlayMode.left+"px"})},rewindMode:function(i,s){h.spriteList[i].characterList.forEach(function(t,e){t.style.top=s[e].top+"px",t.style.left=s[e].left+"px",h.spriteList[i].textBubbleList[e]&&h.spriteList[i].textBubbleList[e].classList.remove("on"),h.spriteList[i].sheetList[e].classList.remove("waiting")})},playSequence:function(t){var e=t.spriteId;if(h.currentSpriteId=e,h.spriteList[e].sequenceList=t.sequence,t.lockElement)for(var i=0;i<h.spriteList[e].characterList.length;i++)h.spriteList[e].characterList[i].style.pointerEvents="none";var s=$ts.ce({tag:"div",class:"playSequenceButton",parent:t.target});t.button.top&&(s.style.top=t.button.top+"px"),t.button.left&&(s.style.left=t.button.left+"px"),s.setAttribute("sprite-id",t.spriteId),s.addEventListener("click",function(t){t.preventDefault(),this.style.display="none",h.currentSpriteId=e,e=t.target.getAttribute("sprite-id");t=h.spriteList[e].sequenceList[0].seq;h.spriteList[e].sheetList[t-1].click()},!1),$ts.addHoverEvents(s)},resetSprite:function(){if(this.allStopSound(),this.hideOtherSprite(),void(this.currentSeq=0)!==h.spriteList[h.currentSpriteId]&&null!==h.spriteList[h.currentSpriteId].sequenceList)for(var t=0;t<h.spriteList[h.currentSpriteId].sequenceList.length;t++)h.spriteList[h.currentSpriteId].sequenceList[t].callBack();h.currentSpriteId&&h.originalSpriteList&&h.originalSpriteList.forEach(function(t){t.circlePlayMode&&t.circlePlayMode.rewind&&h.rewindMode(h.currentSpriteId,h.originalSpriteList)});for(var e=document.querySelectorAll(".playSequenceButton"),t=0;t<e.length;t++)e[t].style.display="block"},allresetSprite:function(){this.resetSprite(),h.currentSpriteId&&h.originalSpriteList&&h.originalSpriteList.forEach(function(t){t.circlePlayMode&&(h.rewindMode(h.currentSpriteId,h.originalSpriteList),t.circle||h.resetSpriteCircle(h.currentSpriteId,h.originalSpriteList))})},resetSpriteCircle:function(t,e){h.spriteList[t].characterList.forEach(function(t,e){t.classList.remove("circle")})},hideOtherSprite:function(){for(var t in this.spriteList)for(var e=0;e<this.spriteList[t].sheetList.length;e++)this.spriteList[t].sheetList[e].classList.contains("waiting")&&this.spriteList[t].sheetList[e].classList.remove("waiting"),this.spriteList[t].sheetList[e].style.opacity=0,this.spriteList[t].thumbNailList[e].style.opacity=1,this.spriteList[t].textBubbleList[e]&&this.spriteList[t].textBubbleList[e].classList.remove("on")}};return h}();